// ==UserScript==
// @name         Update auto format CodeMirror 5.0 with prettier + prettier-plugin-liquid
// @namespace    http://tampermonkey.net/
// @version      2025-11-22
// @description  try to take over the world!
// @author       You
// @match        Change your url
// @icon         https://www.google.com/s2/favicons?sz=64&domain=mysapo.net
// @require 		 https://raw.githubusercontent.com/qthang97/prettier-plugin-liquid-1.10.0/refs/heads/main/prettier-3.6.2-standalone.js
// @require 		 https://raw.githubusercontent.com/qthang97/prettier-plugin-liquid-1.10.0/refs/heads/main/prettier-plugin-liquid-1.10.0-standalone.js
// ==/UserScript==

;(function () {
	'use strict'

	// ===== Utility: lấy CodeMirror instance =====
	const options = {
  parser: "liquid-html", // Parser Liquid + HTML, bắt buộc phải khai báo khi dùng plugin Liquid.

  plugins: [prettierPluginLiquid], // Plugin Liquid cho Prettier. Giúp parse Liquid ({{ }}, {% %}, schema,…)

  // ================= PRETTIER CORE =================
  bracketSameLine: true,
  // Để dấu ngoặc đóng `>` của thẻ HTML/JSX ở cùng dòng với nội dung cuối.
  // Ví dụ:
  // <Component>
  //   text
  // </Component>
  // → chuyển thành:
  // <Component>
  //   text</Component>

  bracketSpacing: true,
  // Thêm khoảng trắng trong object literal.
  // { a: 1 } thay vì {a:1}

  htmlWhitespaceSensitivity: "ignore",
  // Bỏ qua xử lý khoảng trắng HTML theo CSS.
  // Giúp HTML không bị xuống dòng bất thường.

  jsxSingleQuote: true,
  // JSX dùng dấu nháy đơn.
  // <div class='box'> thay vì <div class="box">

  printWidth: 400,
  // Độ dài dòng tối đa.
  // 400 rất lớn → gần như không xuống dòng tự động.

  semi: false,
  // Không dùng dấu `;`.
  // const a = 1 thay vì const a = 1;

  singleAttributePerLine: false,
  // Không bắt HTML phải mỗi attribute 1 dòng.
  // <div a="1" b="2"> thay vì:
  // <div
  //    a="1"
  //    b="2"
  // >

  singleQuote: true,
  // Dùng dấu nháy đơn trong JS/HTML/Liquid.
  // 'text' thay vì "text"

  trailingComma: "all",
  // Thêm dấu phẩy cuối trong object/array/function.
  // Giúp diff git đẹp hơn, code dễ merge.

  useTabs: true,
  // Thụt dòng bằng ký tự tab (\t) thay vì 2 hoặc 4 spaces.
	}
	function getCodeMirror() {
		// Shopify theme editor hoặc bất kỳ trang nào
		let el = document.querySelector('.CodeMirror')
		if (!el) return null

		return el.CodeMirror || el.cm || el.editor || null
	}

	// ===== Format Liquid bằng Prettier =====
	async function formatLiquid(text) {
		return await prettier.format(text, options)
	}

	// ===== Hàm thực hiện format trong CodeMirror =====
	async function formatCodeMirror() {
		let cm = getCodeMirror()
		if (!cm) {
			alert('Không tìm thấy CodeMirror!')
			return
		}

		let content = cm.getValue()
		let formatted = ''

		try {
			formatted = await formatLiquid(content)
		} catch (e) {
			console.error('Liquid format error:', e)
			alert('Lỗi format Liquid, xem console để biết chi tiết.')
			return
		}

		cm.setValue(formatted)
		cm.refresh()
	}

	// ===== Phím tắt: Ctrl + Shift + L =====
	document.addEventListener('keydown', function (e) {
		if (e.ctrlKey && e.shiftKey && e.key.toUpperCase() === 'L') {
			e.preventDefault()
			formatCodeMirror()
		}
	})

	// ===== Phím tắt: Alt + Ctrl + F =====
	document.addEventListener('keydown', function (e) {
		if (e.altKey && e.shiftKey && e.key.toUpperCase() === 'F') {
			e.preventDefault()
			formatCodeMirror()
		}
	})
})()
